# ERC20 Token Balance Fix

This document provides instructions for fixing the issue with ERC20 token balances not being fetched correctly for wallet and contract addresses.

## Overview of Changes

The fix includes several components:

1. **Database Migration**: A new migration script (`008_fix_token_balances_complete.sql`) that:
   - Ensures the token_balances table has all required columns
   - Fixes the trigger function for updating token balances
   - Recalculates all token balances based on historical transfers

2. **Blockchain Service Enhancement**: Updated the `getAddressTokenBalances` method in `src/services/blockchain/tokens.ts` to:
   - Scan for token transfers to the address
   - Fetch token balances directly from the blockchain
   - Provide token metadata (name, symbol, decimals)

3. **API Service Improvement**: Enhanced the `getAddressTokens` method in `src/services/api/tokens.ts` to:
   - Use blockchain fallback when database has no balances
   - Improve error handling for token metadata retrieval
   - Store blockchain-fetched balances in the database

4. **Type Definition Update**: Extended the `TokenBalance` interface in `src/services/database/types.ts` to include:
   - Optional name, symbol, and decimals properties

## How to Apply the Fix

### 1. Apply the Database Migration

Run the following command to apply the database migration:

```bash
# Make sure you're in the project root directory
cd /path/to/mainnet-indexer

# Apply the migration
node scripts/apply-migration.js 008_fix_token_balances_complete.sql
```

This will:
- Update the token balances trigger
- Add any missing columns to the token_balances table
- Recalculate all token balances based on historical transfers

### 2. Restart the Indexer

After applying the migration, restart the indexer service to apply the code changes:

```bash
# If running as a systemd service
sudo systemctl restart studio-indexer

# If running directly
npm run start
```

## Verification

To verify that the fix is working correctly:

1. Check the logs for any errors related to token balances
2. Test the API endpoint for a known address with ERC20 tokens:
   ```
   curl http://localhost:3000/account/0xYourAddressHere/balances
   ```
3. Verify that the response includes the expected ERC20 tokens with correct balances

## Troubleshooting

If you encounter issues after applying the fix:

1. Check the logs for any errors:
   ```
   tail -f logs/studio-indexer.log
   ```

2. Verify that the migration was applied correctly:
   ```sql
   SELECT * FROM migrations WHERE name = '008_fix_token_balances_complete.sql';
   ```

3. Check if the token balances are being updated:
   ```sql
   SELECT COUNT(*) FROM token_balances;
   ```

4. If necessary, you can manually trigger a recalculation of token balances:
   ```sql
   -- Run the recalculation query from the migration
   WITH token_balance_changes AS (
       -- Query from the migration file
       -- ...
   )
   INSERT INTO token_balances (...)
   -- ...
   ```

## Additional Information

The fix addresses several issues:

1. The database trigger wasn't correctly handling all token transfer scenarios
2. There was no fallback to blockchain data when database information was missing
3. Error handling in the API layer was too aggressive, filtering out valid tokens
4. The token balance calculation didn't properly handle tokens with different decimal places

If you have any questions or need further assistance, please contact the development team.
