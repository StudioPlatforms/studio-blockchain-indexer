# Contract Verification Process in Studio Blockchain Mainnet Indexer

This document provides a detailed explanation of the contract verification process in the Studio Blockchain Mainnet Indexer.

## Overview

Contract verification is the process of verifying that a deployed smart contract's bytecode matches the source code that was used to compile it. This allows users to view and interact with the source code of a contract, rather than just the bytecode.

## Verification Service

The verification service is implemented in `src/services/verification/index.ts`. It provides the following functionality:

- Loading and caching Solidity compiler versions
- Compiling Solidity source code with specified settings
- Comparing compiled bytecode with on-chain bytecode
- Handling constructor arguments and libraries
- Extracting and validating metadata hashes
- Validating constructor arguments

## Verification Process

The verification process works as follows:

1. **Submit Verification Request**: The user submits a verification request with the following parameters:
   - Contract address
   - Source code
   - Compiler version
   - Contract name
   - Optimization used (boolean)
   - Optimization runs (number)
   - Constructor arguments (hex string)
   - Libraries (object mapping library names to addresses)
   - EVM version

2. **Validate Request**: The system validates the request parameters:
   - Checks if the address is a valid contract on the blockchain
   - Validates the constructor arguments (must be a valid hex string)
   - Checks if the contract exists in the database

3. **Get On-Chain Bytecode**: The system retrieves the bytecode of the contract from the blockchain using the `getCode` method of the blockchain service.

4. **Compile Source Code**: The system compiles the source code with the specified settings:
   - Loads the specified compiler version
   - Sets up the compiler input with the specified settings
   - Compiles the source code
   - Extracts the compiled bytecode and ABI

5. **Compare Bytecodes**: The system compares the compiled bytecode with the on-chain bytecode:
   - Removes metadata hash (last 43 bytes) from both bytecodes
   - Compares the bytecodes
   - If the bytecodes don't match, checks if the difference is due to constructor arguments

6. **Store Verification Data**: If the bytecodes match, the system stores the verification data in the database:
   - Sets the `verified` flag to `true`
   - Stores the source code, ABI, and compilation settings
   - Sets the `verified_at` timestamp

7. **Return Result**: The system returns the verification result to the user:
   - Success or failure status
   - Error message if verification failed
   - ABI, bytecode, and metadata if verification succeeded

## API Endpoints

The contract verification API is implemented in `src/services/api/contracts.ts`. It provides the following endpoints:

- `POST /contracts/verify`: Submit a contract for verification
- `GET /contracts/:address/verified`: Check if a contract is verified
- `GET /contracts/:address/abi`: Get the ABI of a verified contract
- `GET /contracts/:address/source`: Get the source code of a verified contract
- `POST /contracts/:address/interact`: Interact with a verified contract

## Database Schema

The contract verification data is stored in the `contracts` table. The following columns are used for contract verification:

- `verified`: A boolean indicating whether the contract is verified.
- `source_code`: The source code of the contract.
- `abi`: The ABI of the contract.
- `compiler_version`: The compiler version used to compile the contract.
- `optimization_used`: A boolean indicating whether optimization was used when compiling the contract.
- `runs`: The number of optimization runs.
- `constructor_arguments`: The constructor arguments used to deploy the contract.
- `libraries`: The libraries used by the contract.
- `verified_at`: The timestamp when the contract was verified.
- `evm_version`: The EVM version used for compilation.

## Compiler Version Management

The verification service loads and caches Solidity compiler versions from the Solidity binaries repository. It uses the `solc` npm package to load and use the compiler.

The service maintains a cache of compiler versions to avoid downloading the same compiler multiple times. It also handles version resolution, ensuring that the correct compiler version is used for each verification request.

## EVM Version Support

The verification service supports specifying the EVM version to use for compilation. The EVM version is stored in the database and used when compiling the contract. If not specified, the default EVM version is "cancun".

The service also includes logic to determine the appropriate EVM version based on the compiler version, ensuring that the EVM version is compatible with the compiler version.

## Error Handling

The verification service provides detailed error messages for various failure scenarios:

- Missing required parameters
- Invalid contract address
- Contract not found in the database
- Invalid constructor arguments
- Compilation errors
- Bytecode mismatch
- Method not found in the ABI

## Conclusion

The contract verification process in the Studio Blockchain Mainnet Indexer is a comprehensive system that allows users to verify smart contracts by submitting the source code, compiler version, and other compilation settings. The system compiles the source code and compares the resulting bytecode with the on-chain bytecode to verify that the source code matches the deployed contract.
